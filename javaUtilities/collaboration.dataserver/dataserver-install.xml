<project default="main" basedir=".">

	<property name="workspace" value="${basedir}/../.." />
	<property name="esb.build.directory" value="${workspace}/edexOsgi/build.edex" />
	<property name="feature.file" value="${basedir}.feature/feature.xml"/>
	<property name="dataserver.root.directory" value="/awips2/collab-dataserver" />
	<property name="includegen.filter" value="raytheon|collaboration.dataserver" />
	<property name="basedirectories" value="${workspace}/edexOsgi;${workspace}/javaUtilities;${workspace}/cots" />


	<!-- import -->
	<import file="${esb.build.directory}/deploy-common/plugin-methods.xml" />

	<!-- public static final -->
	<path id="ant.classpath">
		<fileset dir="${esb.build.directory}/lib/ant">
			<include name="*.jar" />
		</fileset>
	</path>


	<target name="main" >
		<sequential>
			<!-- prepare to run includegen -->
			<var name="includes.directory" value="${basedir}/tmp/includes" />
			<if>
				<available file="${includes.directory}" type="dir" />
				<then>
					<delete verbose="true" includeemptydirs="true">
						<fileset dir="${includes.directory}" 
							includes="*/**" />
					</delete>
				</then>
			</if>
			<mkdir dir="${includes.directory}" />

			<!-- run includegen -->
			<echo message="Generating deployment list for feature: ${feature}" />

			<includegen providerfilter="${includegen.filter}" 
            	basedirectories="${basedirectories}" 
            	featurefile="${feature.file}" 
            	cotsout="${includes.directory}/cots.includes" 
            	plugsout="${includes.directory}/plugins.includes" 
            	coreout="${includes.directory}/core.includes" />

			<var name="destination.directory"
				value="${dataserver.root.directory}/lib/plugins" />
			<mkdir dir="${destination.directory}" />
			<processPlugins
				includes.file="${includes.directory}/plugins.includes"
				plugin.type="plugins"
				plugin.directories="${basedirectories}"
				destination.directory="${destination.directory}" />
			<processPlugins
				includes.file="${includes.directory}/core.includes"
				plugin.type="core"
				plugin.directories="${basedirectories}"
				destination.directory="${destination.directory}" />

			<var name="destination.directory"
				value="${dataserver.root.directory}/lib/dependencies" />
			<mkdir dir="${destination.directory}" />
			<processPlugins
				includes.file="${includes.directory}/cots.includes"
				plugin.type="cots"
				plugin.directories="${basedirectories}"
				destination.directory="${destination.directory}" />

			<!-- deploy scripts and config -->
			<copy todir="${dataserver.root.directory}/config" overwrite="false" verbose="true">
				<fileset dir="${basedir}/config" />
			</copy>
			<copy todir="${dataserver.root.directory}/bin" overwrite="true" verbose="true">
				<fileset dir="${basedir}/scriptBin" />
			</copy>
			<chmod dir="${dataserver.root.directory}/bin" perm="ug+rx" includes="**/*.sh"/>

			<!-- cleanup the temporary directories -->
			<if>
				<available file="${basedir}/tmp" type="dir" />
				<then>
					<delete includeemptydirs="true">
						<fileset dir="${basedir}"
							includes="tmp/**" />
					</delete>
				</then>
			</if>
		</sequential>
	</target>


	<!-- static -->
	<taskdef name="includegen" 
    	classname="com.raytheon.uf.anttasks.includesgen.GenerateIncludesFromFeature"
    	classpathref="ant.classpath" />
	<taskdef resource="net/sf/antcontrib/antlib.xml" 
		classpath="${esb.build.directory}/lib/ant/ant-contrib-1.0b3.jar" />
</project>