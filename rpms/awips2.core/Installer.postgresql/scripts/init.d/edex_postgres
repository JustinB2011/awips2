#!/bin/bash
#
# edex_postgres  This shell script takes care of starting and stopping
#                the AWIPS EDEX postgreSQL instance.
#
# chkconfig: - 99 10
# description: PostgreSQL database, which is the instance \
#              used by AWIPS EDEX.
# processname: postmaster
# config: %database_files_home/postgresql.conf

# Source function library.
. /etc/rc.d/init.d/functions

# Source networking configuration.
. /etc/sysconfig/network

# Check that networking is up.
[ ${NETWORKING} = "no" ] && exit 0

RETVAL=0
prog="postmaster"
# Installation prefix

# We will no longer be using hard-coded paths that need to be replaced.
# Use rpm to find the paths that we need.
JAVA_INSTALL=`rpm -q --queryformat '%{INSTALLPREFIX}\n' awips2-java`
RC="$?"
if [ ! "${RC}" = "0" ]; then
   echo "ERROR: awips2-java Must Be Installed."
   echo "Unable To Continue ... Terminating."
   exit 1
fi
PYTHON_INSTALL=`rpm -q --queryformat '%{INSTALLPREFIX}\n' awips2-python`
RC="$?"
if [ ! "${RC}" = "0" ]; then
   echo "ERROR: awips2-python Must Be Installed."
   echo "Unable To Continue ... Terminating."
   exit 1
fi
PSQL_INSTALL=`rpm -q --queryformat '%{INSTALLPREFIX}\n' awips2-psql`
RC="$?"
if [ ! "${RC}" = "0" ]; then
   echo "ERROR: awips2-psql Must Be Installed."
   echo "Unable To Continue ... Terminating."
   exit 
fi
POSTGRESQL_INSTALL_ROOT=`rpm -q --queryformat '%{INSTALLPREFIX}\n' awips2-postgresql`
POSTGRESQL_INSTALL="${POSTGRESQL_INSTALL_ROOT}/postgresql"
PGDATA_DIR="${POSTGRESQL_INSTALL_ROOT}/data"

# Data directory
PGDATA="${PGDATA_DIR}"
# Who to run the postmaster as, usually "postgres".  (NOT "root")
PGUSER=awips
# Port to start the database with
PGPORT=5432
# Where to keep a log file
PGLOG="$PGDATA/serverlog"
# The path that is to be used for the script
PATH=${JAVA_INSTALL}/bin:${PYTHON_INSTALL}/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
export LD_LIBRARY_PATH=${JAVA_INSTALL}/lib:${PYTHON_INSTALL}/lib:${PSQL_INSTALL}/lib
# What to use to start up the postmaster (we do NOT use pg_ctl for this,
# as it adds no value and can cause the postmaster to misrecognize a stale
# lock file)
DAEMON="${POSTGRESQL_INSTALL}/bin/postmaster"
# What to use to shut down the postmaster
PGCTL="${POSTGRESQL_INSTALL}/bin/pg_ctl"

[ -x $DAEMON ] || exit 0
[ -x $PGCTL ] || exit 0

# See how we were called.
case $1 in
  start)
	echo -n "Starting EDEX PostgreSQL: "
	su $PGUSER -c "$DAEMON -D '$PGDATA' -p $PGPORT &" >>$PGLOG 2>&1
	echo
	RETVAL=$?
	;;
  stop)
	echo -n "Stopping EDEX PostgreSQL: "
	su $PGUSER -c "$PGCTL stop -D '$PGDATA' -s -m fast -o \"-p $PGPORT\""
	echo
	RETVAL=$?
	;;
  restart)
	echo -n "Restarting EDEX PostgreSQL: "
	su $PGUSER -c "$PGCTL stop -D '$PGDATA' -s -m fast -w -o \"-p $PGPORT\""
	su $PGUSER -c "$DAEMON -D '$PGDATA' -p $PGPORT &" >>$PGLOG 2>&1
	RETVAL=$?
	;;
  reload)
        echo -n "Reload EDEX PostgreSQL: "
        su $PGUSER -c "$PGCTL reload -D '$PGDATA' -s -o \"-p $PGPORT\""
        RETVAL=$?
        ;;
  status)
	su $PGUSER -c "$PGCTL status -D '$PGDATA' -o \"-p $PGPORT\""
	;;
  *)
	# Print help
	echo "Usage: $0 {start|stop|restart|reload|status}" 1>&2
	exit 1
	;;
esac

exit $RETVAL
